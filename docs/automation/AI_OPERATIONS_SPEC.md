# AI Operations Specification (AI_OPERATIONS_SPEC)

> **Auto-Generated by:** Technical Writer Agent
> **Source Document:** `docs/SS7_HA_GATEWAY_OPERATIONS_GUIDE.md` (v2.0.0)
> **Purpose:** Provides structured, machine-parsable operational data for AI Agents managing the SS7 HA Gateway.

## 1. System Entities & States

Defines the core components the AI Agent monitors and manages.

| Entity | Attributes | Healthy State | Critical State |
| :--- | :--- | :--- | :--- |
| `SCTP_ASSOCIATION` | `assoc_id`, `remote_host`, `status` | `ESTABLISHED`, `COMM_UP` | `CLOSED`, `COMM_LOST`, `SHUTDOWN` |
| `NATS_CONNECTION` | `url`, `status`, `rtt` | `CONNECTED` | `DISCONNECTED`, `RECONNECTING` |
| `DIALOG_POOL` | `active_count`, `max_capacity` | `usage < 80%` | `usage > 95%` |
| `INSTANCE` | `pod_name`, `role` (ACTIVE/STANDBY) | `Running`, `Ready` | `CrashLoopBackOff`, `Terminating` |

---

## 2. Event Catalog (Alarm & Event Definitions)

Maps raw system events to standardized codes and severity levels.

| Event Code | Severity | Trigger Condition (PromQL / Logic) | Description | Impact |
| :--- | :--- | :--- | :--- | :--- |
| `EVT-CRIT-001` | **CRITICAL** | `up{job="ss7-ha-gateway"} == 0` | Instance Down | Service loss on that node. |
| `EVT-CRIT-002` | **CRITICAL** | `ss7_sctp_associations_active == 0` | SCTP Link Down | Total signaling outage. |
| `EVT-CRIT-003` | **CRITICAL** | `ss7_nats_connected == 0` | NATS Disconnected | Cannot send/receive messages to apps. |
| `EVT-CRIT-004` | **CRITICAL** | `ss7_dialogs_active / max > 0.95` | Dialog Saturation | New calls/SMS will be rejected. |
| `EVT-WARN-001` | **WARNING** | `rate(errors) / rate(total) > 0.01` | High Error Rate | Service degradation (1% failure). |
| `EVT-WARN-002` | **WARNING** | `p99_latency > 500ms` | High Latency | Slow SMS delivery. |
| `EVT-INFO-001` | **INFO** | Log: `Instance started` | Startup | Node joined cluster. |

---

## 3. Log Parsing Rules (Regex)

Regex patterns to extract structured events from unstructured logs.

| Target Event | Regex Pattern | Extracted Fields |
| :--- | :--- | :--- |
| `SCTP_LINK_DOWN` | `SCTP Association (\d+) lost.*peer=(.*)` | `assocId`, `peerIp` |
| `DIALOG_TIMEOUT` | `Dialog (\d+) timed out.*remoteGT=(.*)` | `dialogId`, `gt` |
| `NATS_DISCONNECT` | `NATS connection lost.*url=(.*)` | `natsUrl` |
| `HEAP_OOM` | `java.lang.OutOfMemoryError: Java heap space` | - |
| `CONFIG_ERROR` | `Invalid configuration.*property=(.*)` | `property` |

---

## 4. Remediation Playbooks

Actionable steps to resolve specific events.

### Playbook: `FIX_SCTP_LINK_DOWN`
**Trigger:** `EVT-CRIT-002` or Log `SCTP_LINK_DOWN`

1.  **Check Status:**
    ```bash
    kubectl exec -n ss7-ha-gateway $POD_NAME -- cat /proc/net/sctp/assocs
    ```
2.  **Test Connectivity:**
    ```bash
    kubectl exec -n ss7-ha-gateway $POD_NAME -- nc -z -v $REMOTE_HOST 2905
    ```
3.  **Action (If unreachable):** Report Network Issue to NOC.
4.  **Action (If reachable but down):** Restart Pod (Force Reconnect).
    ```bash
    kubectl delete pod $POD_NAME -n ss7-ha-gateway
    ```

### Playbook: `FIX_NATS_DISCONNECT`
**Trigger:** `EVT-CRIT-003` or Log `NATS_DISCONNECT`

1.  **Check NATS Cluster:**
    ```bash
    kubectl get pods -l app=nats -n ss7-ha-gateway
    ```
2.  **Check Gateway Connectivity:**
    ```bash
    kubectl exec -n ss7-ha-gateway $POD_NAME -- curl -s http://localhost:8080/health | grep nats
    ```
3.  **Action:** If NATS pods are down, restart NATS StatefulSet.
    ```bash
    kubectl rollout restart statefulset nats -n ss7-ha-gateway
    ```

### Playbook: `FIX_DIALOG_SATURATION`
**Trigger:** `EVT-CRIT-004`

1.  **Check Active Dialogs:**
    ```bash
    curl -s http://localhost:9090/metrics | grep ss7_dialogs_active
    ```
2.  **Action (Immediate):** Scale up Gateway Cluster.
    ```bash
    kubectl scale statefulset ss7-ha-gateway -n ss7-ha-gateway --replicas=$(($CURRENT_REPLICAS + 1))
    ```
3.  **Action (Investigation):** Check for "Stuck Dialogs" in logs.

---

## 5. Integration Interfaces: How to Listen?

The AI Agent requires a real-time feed of events to act proactively. The system supports two ingestion methods.

### 5.1. Method A: NATS Ops Stream (Preferred)
The gateway publishes internal state changes and alarms to a dedicated NATS subject. The AI Agent should subscribe to this stream.

*   **Subject:** `ops.events.>` (e.g., `ops.events.alarm`, `ops.events.audit`)
*   **Stream Name:** `SS7_OPS_STREAM`

#### JSON Payload Schema
```json
{
  "eventId": "uuid-1234-5678",
  "timestamp": "2025-12-16T14:30:00Z",
  "type": "ALARM",             // ALARM, AUDIT, METRIC
  "code": "EVT-CRIT-002",      // Maps to Event Catalog
  "severity": "CRITICAL",      // INFO, WARNING, CRITICAL
  "source": {
    "nodeId": "ss7-gateway-0",
    "component": "SCTP_LAYER"
  },
  "details": {
    "message": "SCTP Association lost",
    "assocId": 12,
    "remotePeer": "10.0.0.5"
  }
}
```

### 5.2. Method B: Webhook (Prometheus Alertmanager)
If using Prometheus for monitoring, configure Alertmanager to push alerts to the AI Agent's webhook receiver.

*   **Endpoint:** `POST /api/v1/alerts` (on the AI Agent)
*   **Payload Format:** Standard Prometheus JSON

```json
{
  "status": "firing",
  "labels": {
    "alertname": "SS7SCTPAssociationDown",
    "severity": "critical",
    "alarm_id": "EVT-CRIT-002",
    "instance": "ss7-gateway-0"
  },
  "annotations": {
    "summary": "SCTP Link Down",
    "description": "Association 12 lost connection to 10.0.0.5"
  }
}
```

---

## 6. Known Error Codes (Knowledge Base)

| Error Code | Context | Meaning | Suggested Action |
| :--- | :--- | :--- | :--- |
| `TCAP-001` | Dialog | Timeout waiting for peer. | Check peer load/latency. |
| `MAP-003` | MAP | Protocol version mismatch. | Verify `map.version` config matches peer. |
| `SCTP-002` | Network | Init timer expired. | Firewall blocking SCTP or peer down. |

---

## 7. Command Reference (Egress)

This section defines the JSON commands the AI Agent can send to the Gateway via NATS to control network traffic.
**Subject Pattern:** `cap.command.<type>` or `map.command.<type>` (e.g., `cap.command.connect`)

### 7.1. Voice Control (CAP v4)

**CONNECT**
Redirects a call to a new destination.
```json
{
  "type": "CONNECT",
  "dialogId": 123456,
  "payload": {
    "destinationRoutingAddress": "905551234567", // Mandatory
    "callingPartyNumber": "905339876543",        // Optional
    "originalCalledPartyID": "0401...",          // Optional (Hex)
    "redirectingPartyID": "0402...",             // Optional (Hex)
    "genericNumbers": ["0403...", "0404..."],    // Optional (Hex Array)
    "serviceInteractionIndicatorsTwo": "02..."   // Optional (Hex)
  }
}
```

**RELEASE_CALL**
Tears down the call.
```json
{
  "type": "RELEASE_CALL",
  "dialogId": 123456,
  "payload": {
    "cause": 31 // Q.850 Cause Code (Integer)
  }
}
```

**APPLY_CHARGING**
Sets a time limit or quota for the call.
```json
{
  "type": "APPLY_CHARGING",
  "dialogId": 123456,
  "payload": {
    "achBillingChargingCharacteristics": "A0...", // Hex (CAMEL-AChBillingChargingCharacteristics)
    "partyToCharge": "A1...",                     // Hex (SendingSideID)
    "timeDurationCharging": {                     // Simplified Alternative (if supported)
       "maxCallPeriodDuration": 600,
       "releaseIfdurationExceeded": true
    }
  }
}
```

### 7.2. SMS Control (CAP v3/4)

**CONNECT_SMS**
Modifies SMS routing or content.
```json
{
  "type": "CONNECT_SMS",
  "dialogId": 789012,
  "payload": {
    "callingPartysNumber": "04...",              // Hex (SMSAddressString)
    "destinationSubscriberNumber": "04...",      // Hex (CalledPartyBCDNumber)
    "smscAddress": "04..."                       // Hex (ISDNAddressString)
  }
}
```

**CONTINUE_SMS**
Allows SMS to proceed.
```json
{
  "type": "CONTINUE_SMS",
  "dialogId": 789012,
  "payload": {}
}
```

### 7.3. GPRS Control (CAP v3)

**CONNECT_GPRS**
Modifies PDP Context parameters.
```json
{
  "type": "CONNECT_GPRS",
  "dialogId": 345678,
  "payload": {
    "accessPointName": "04...", // Hex (AccessPointName)
    "pdpId": "01"               // Hex (PDPID)
  }
}
```

### 7.4. MAP Operations

**MAP_UPDATE_LOCATION_RES**
Sends a response to an Update Location request.
```json
{
  "type": "MAP_UPDATE_LOCATION_RES",
  "dialogId": 567890,
  "payload": {
    "hlrNumber": "91...",       // Hex (ISDN Address)
    "extensionContainer": "..." // Hex
  }
}
```

**Note:** All complex ASN.1 parameters (extensions, bearer capabilities, location info) must be provided as **Hex Strings** representing the BER-encoded data. The Gateway uses "Hex Passthrough" to inject these directly into the SS7 message.
